name: Upstream Sync and Build Docker

permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  sync_and_build:
    name: Sync Upstream (default branch) and Build Docker
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # 0) è¯»å–ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ï¼ˆnext / main è‡ªåŠ¨é€‚é…ï¼‰
      - name: Get upstream default branch
        id: get-default
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_REPO="lobehub/lobe-chat"
          DEFAULT_BRANCH=$(gh api repos/$UPSTREAM_REPO --jq .default_branch)
          echo "repo=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
          echo "branch=$DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"

      # 1) æ£€å‡ºå½“å‰ä»“åº“ï¼ˆæ‹¿åˆ°å®Œæ•´å†å²ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) å…³é—­å†å²â€œåŒæ­¥å¤±è´¥â€ issueï¼ˆå¯é€‰ï¼‰
      - name: Clean issue notice
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'ğŸš¨ Sync Fail'

      # 3) å¼ºåˆ¶å¯¹é½ï¼šæŠŠ fork çš„ <default-branch> ç¡¬é‡ç½®ä¸ºä¸Šæ¸¸çš„åŒååˆ†æ”¯
      #    - æ²¡æœ‰è¯¥åˆ†æ”¯å°±åˆ›å»º
      #    - BEFORE_SHA / AFTER_SHA ç”¨æ¥åˆ¤æ–­æ˜¯å¦çœŸæœ‰æ–°æäº¤
      - name: Force mirror upstream default branch
        id: mirror
        env:
          UPSTREAM_REPO: ${{ steps.get-default.outputs.repo }}
          BRANCH: ${{ steps.get-default.outputs.branch }}
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # è®°å½•é‡ç½®å‰çš„è¿œç«¯ HEADï¼ˆfork çš„è¯¥åˆ†æ”¯ï¼‰
          git fetch --prune origin
          BEFORE_SHA=$(git ls-remote origin "refs/heads/$BRANCH" | awk '{print $1}')
          echo "before_sha=${BEFORE_SHA:-none}" >> "$GITHUB_OUTPUT"

          # ç¡®ä¿æœ¬åœ°æœ‰è¯¥åˆ†æ”¯ï¼ˆæ²¡æœ‰å°±ä» origin/main æˆ– origin/HEAD åˆ›å»ºå ä½ï¼‰
          if ! git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            git checkout -B "$BRANCH"
            git push -u origin "$BRANCH"
          else
            git checkout "$BRANCH"
          fi

          # æ·»åŠ å¹¶æŠ“å–ä¸Šæ¸¸
          if ! git remote | grep -q "^upstream$"; then
            git remote add upstream "https://github.com/$UPSTREAM_REPO.git"
          fi
          git fetch --prune upstream

          # å–å¾—ä¸Šæ¸¸è¯¥åˆ†æ”¯çš„æœ€æ–° SHA
          UPSTREAM_SHA=$(git rev-parse "upstream/$BRANCH")
          echo "upstream_sha=$UPSTREAM_SHA" >> "$GITHUB_OUTPUT"

          # å¦‚æœ fork ä¸ä¸Šæ¸¸ç›¸åŒåˆ™æ— éœ€æ¨é€/æ„å»º
          if [ -n "$BEFORE_SHA" ] && [ "$BEFORE_SHA" = "$UPSTREAM_SHA" ]; then
            echo "has_new_commits=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ç¡¬é‡ç½®åˆ°ä¸Šæ¸¸ï¼ˆé¿å…ä»»ä½•å†²çªï¼‰
          git reset --hard "upstream/$BRANCH"

          # æ¨å› forkï¼ˆå¼ºåˆ¶ï¼‰
          git push origin "$BRANCH" --force

          echo "has_new_commits=true" >> "$GITHUB_OUTPUT"

      # 4) åŒæ­¥å¤±è´¥æ—¶å»º issueï¼ˆmirror æ­¥éª¤å¼‚å¸¸æ‰ä¼šèµ°åˆ°è¿™ï¼‰
      - name: Sync check
        if: failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥ | Sync Fail'
          labels: 'ğŸš¨ Sync Fail'
          body: |
            å¼ºåˆ¶åŒæ­¥ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æˆ–æ‰‹åŠ¨å¤„ç†ã€‚
            Upstream: lobehub/lobe-chat

      # 5) ä¸ºæ„å»ºé‡æ–°æ£€å‡ºåˆšåŒæ­¥çš„åˆ†æ”¯
      - name: Checkout synced branch for build
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-default.outputs.branch }}
          fetch-depth: 0

      # 6) é€‰æ‹© Dockerfileï¼ˆä¸Šæ¸¸åˆ äº† Dockerfile.database å°±è‡ªåŠ¨æ¢ç”¨æ ¹ç›®å½• Dockerfileï¼›éƒ½æ²¡æœ‰å°±è·³è¿‡æ„å»ºï¼‰
      - name: Resolve Dockerfile path
        id: dkfile
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' }}
        run: |
          if [ -f "./Dockerfile.database" ]; then
            echo "file=./Dockerfile.database" >> "$GITHUB_OUTPUT"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          elif [ -f "./Dockerfile" ]; then
            echo "file=./Dockerfile" >> "$GITHUB_OUTPUT"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' && steps.dkfile.outputs.exists == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' && steps.dkfile.outputs.exists == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ ‡ç­¾ï¼šlatest + ä¸ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯åŒåï¼ˆnext/mainï¼‰ + çŸ­ sha
      - name: Extract metadata (tags, labels)
        id: meta
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' && steps.dkfile.outputs.exists == 'true' }}
        uses: docker/metadata-action@v5
        with:
          images: marvinlee514/lobechat-docker-clerk
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.get-default.outputs.branch }}
            type=sha,format=short

      - name: Build and push Docker image (amd64)
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' && steps.dkfile.outputs.exists == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dkfile.outputs.file }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_ARG=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
            CLERK_WEBHOOK_SECRET_ARG=${{ secrets.CLERK_WEBHOOK_SECRET }}
            CLERK_SECRET_KEY_ARG=${{ secrets.CLERK_SECRET_KEY }}

      # æ²¡æœ‰ Dockerfile æ—¶ç»™å‡ºæç¤ºä½†ä¸ä¸­æ–­
      - name: Skip build (no Dockerfile found)
        if: ${{ steps.mirror.outputs.has_new_commits == 'true' && steps.dkfile.outputs.exists != 'true' }}
        run: |
          echo "No Dockerfile or Dockerfile.database found in repo. Skip image build."
