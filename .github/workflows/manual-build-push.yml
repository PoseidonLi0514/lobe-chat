name: Manual Docker Build and Push (Latest Pushed Branch)

permissions:
  contents: read

on:
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Find latest pushed branch
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          REPO="${GITHUB_REPOSITORY}"
          DEFAULT_BRANCH=$(gh api repos/$REPO --jq .default_branch)
          REF=$(gh api repos/$REPO/events --jq 'first(.[] | select(.type=="PushEvent")).payload.ref' || true)
          BRANCH="${REF#refs/heads/}"
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "refs/heads/" ]; then
            BRANCH="$DEFAULT_BRANCH"
          fi
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.latest.outputs.branch }}
          fetch-depth: 0

      - name: Resolve Dockerfile path
        id: dkfile
        run: |
          if [ -f "./Dockerfile.database" ]; then
            echo "file=./Dockerfile.database" >> "$GITHUB_OUTPUT"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          elif [ -f "./Dockerfile" ]; then
            echo "file=./Dockerfile" >> "$GITHUB_OUTPUT"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: ${{ steps.dkfile.outputs.exists == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: ${{ steps.dkfile.outputs.exists == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image tags
        id: meta
        if: ${{ steps.dkfile.outputs.exists == 'true' }}
        run: |
          IMAGE="marvinlee514/lobechat-docker-clerk"
          BRANCH="${{ steps.latest.outputs.branch }}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "tags=$IMAGE:latest,$IMAGE:$BRANCH,$IMAGE:$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image (amd64)
        if: ${{ steps.dkfile.outputs.exists == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dkfile.outputs.file }}
          platforms: linux/amd64
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            NEXT_PUBLIC_ENABLE_NEXT_AUTH=${{ vars.NEXT_PUBLIC_ENABLE_NEXT_AUTH }}
            NEXT_PUBLIC_ENABLE_CLERK_AUTH=${{ vars.NEXT_PUBLIC_ENABLE_CLERK_AUTH }}
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

      - name: Skip build (no Dockerfile found)
        if: ${{ steps.dkfile.outputs.exists != 'true' }}
        run: echo "No Dockerfile or Dockerfile.database found. Skip."
